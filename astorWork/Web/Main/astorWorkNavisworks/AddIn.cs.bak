using Autodesk.Navisworks.Api.Plugins;
using System;
using System.IO;
using System.Reflection;
using System.Windows;

namespace astorWork_Navisworks
{
    [Plugin("Astoria.MaterialSyncAddIn", "ASTR",
       DisplayName = "Material Status Update",
       ToolTip = "Sync the material status into TimeLiner")]
    
    [AddInPlugin(AddInLocation.AddIn,
        Icon = "Assets/16.ico",
        LargeIcon = "Assets/32.ico")]

    public class AddIn : AddInPlugin
    {
        private MainWindow _wnd = null;
        public override int Execute(params string[] parameters)
        {	
            if (Autodesk.Navisworks.Api.Application.IsAutomated)
            {
                throw new InvalidOperationException("Invalid when running using Automation");
            }
            else if (string.IsNullOrEmpty(Autodesk.Navisworks.Api.Application.ActiveDocument.FileName))
            {
                MessageBox.Show("Please open a model first");
                return 1;
            }
            else
            {
                AppDomain currentDomain = AppDomain.CurrentDomain;
                currentDomain.AssemblyResolve += CurrentDomain_AssemblyResolve;


                if(_wnd == null)
                    _wnd = new MainWindow();

                _wnd.Show();
                
                return 0;
            }
        }

        private Assembly CurrentDomain_AssemblyResolve(object sender, ResolveEventArgs args)
        {
            string folderPath = Path.GetDirectoryName(Assembly.GetAssembly(typeof(AddIn)).Location);
            string assemblyPath = Path.Combine(folderPath, new AssemblyName(args.Name).Name + ".dll");
            if (!File.Exists(assemblyPath)) return null;
            Assembly assembly = Assembly.LoadFrom(assemblyPath);
            return assembly;
        }
    }
}
